---
title: "supervisor inotifywait and rsync file from grav to hugo."
date: 2019-01-04T15:04:10.000Z
description: supervisor inotifywait and rsync file from grav to hugo
image: /img/manager_screenshot@2x.png
---

从grav中同步生成的blog md文件到hugo 生成静态文件.

过程中使用了 rsync 来同步数据. 但是有一个_index.md 不希望被删除

于是加上了  rsync -a --delete --exclude “_index.md” dir1 dir2

但是无论如何都不生效. 反复检查后,发现inotifywait 脚本好像还在被执行.

ps -ef | grep inotifywait 检查,我去,一大片..这就奇怪了明明是supervisor 管理着呢,看起来像是只启动了,却没有关闭.

ps -ef | grep inotifywait | grep -v ‘grep’ | awk ‘{print $2}’ | xargs -r kill -9

全部干掉. 修改配置发现supervisor 的配置中没有加上下面几个参数.

I think you are missing an option to propagate the kill signal to all the child processes when you do supervisorctl stop all. Usually one has a parent process and children, when the parent gets SIGTERM/SIGINT it will/should have a coordinated way and should be the one in charge of sending signals or by other means shutting down the children.

The supervisord provides just an option for that. From the official documentation

stopasgroup

If true, the flag causes supervisor to send the stop signal to the whole process group and implies killasgroup is true. This is useful for programs, such as Flask in debug mode, that do not propagate stop signals to their children, leaving them orphaned.

killasgroup

If true, when resorting to send SIGKILL to the program to terminate it send it to its whole process group instead, taking care of its children as well, useful e.g with Python programs using multiprocessing.

The killasgroup kills all processes in the group when Supervisor resorts to sending a SIGKILL. The idea is that when the process is playing nicely, it should be allowed to handle stopping it's children on its own. But when it misbehaves and needs an option for force the whole process group to termination.

Also remember propagating SIGINT, though the default action is to terminate gracefully can be ignored by processes. If you are not worried too much about graceful termination of the script, you can pass SIGKILL which is the equivalent of signal generated by kill -9 in Linux.

So the following options in your supervisor config file

[program:watch]
command=/root/watch_data.sh
user=root
stderr_logfile=/var/log/supervisord/watch_cloud.log
stdout_logfile=/var/log/supervisord/watch_cloud.log
stopasgroup=true
killasgroup=true
stopsignal=KILL
shareimprove this answer
answered Dec 16 '17 at 6:01

Inian
39k63871
I tried your changes but still same. When I stop the program watch supervisorctl stop watch , I can still see inotifywait running. – Optimus Dec 16 '17 at 17:42
1
Correction! I forgot to remove autorestart=true. Now it looks like it's working. Let me play with it a little bit more :) – Optimus Dec 16 '17 at 17:44

https://stackoverflow.com/questions/47734494/inotifywait-is-not-killed-with-supervisorctl-stop


OK,一切都正常了.
这几个工具都值得深入研究.先记录一下.